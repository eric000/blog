# ç›‘æµ‹h5

[TOC]

## âœ¨ ç‰¹æ€§

ç›‘æµ‹

## :pencil: åŸç†

* è·¯ç”±åˆ‡æ¢

  * href
  * Hashchange

      ````js
      window.addEventListener('hashchange', function() {
        // ä¸ŠæŠ¥ã€è¿›å…¥é¡µé¢ã€‘äº‹ä»¶
      }, true)
      ````

  * History API

    ```js

    // ç¬¬ä¸€é˜¶æ®µï¼šæˆ‘ä»¬å¯¹åŸç”Ÿæ–¹æ³•è¿›è¡ŒåŒ…è£…ï¼Œè°ƒç”¨å‰æ‰§è¡Œ dispatchEvent äº†ä¸€ä¸ªåŒæ ·çš„äº‹ä»¶
    function aop (type) {
      var source = window.history[type];
      return function () {
        var event = new Event(type);
        event.arguments = arguments;
        window.dispatchEvent(event);
        var rewrite = source.apply(this, arguments);
        return rewrite;
      };
    }

    // ç¬¬äºŒé˜¶æ®µï¼šå°† pushState å’Œ replaceState è¿›è¡ŒåŸºäº AOP æ€æƒ³çš„ä»£ç æ³¨å…¥
    window.history.pushState = aop('pushState');
    window.history.replaceState = aop('replaceState'); // æ›´æ”¹è·¯ç”±ï¼Œä¸ä¼šç•™ä¸‹å†å²è®°å½•

    // ç¬¬ä¸‰é˜¶æ®µï¼šæ•è·pushState å’Œ replaceState
    window.addEventListener('pushState', function() {
      // ä¸ŠæŠ¥ã€è¿›å…¥é¡µé¢ã€‘äº‹ä»¶
    }, true)
    window.addEventListener('replaceState', function() {
      // ä¸ŠæŠ¥ã€è¿›å…¥é¡µé¢ã€‘äº‹ä»¶
    }, true)
    ```

* å¼‚å¸¸
  * `window.onerror` å’Œ `window.addEventListener('error')`ã€‚(tip:ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ•è· JS å¼‚å¸¸ä¸æ¨èä½¿ç”¨ `addEventListener('error')`ï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒæ²¡æœ‰å †æ ˆä¿¡æ¯ï¼Œè€Œä¸”è¿˜éœ€è¦å¯¹æ•è·åˆ°çš„ä¿¡æ¯åšåŒºåˆ†ï¼Œå› ä¸ºå®ƒä¼šå°†æ‰€æœ‰å¼‚å¸¸ä¿¡æ¯æ•è·åˆ°ï¼ŒåŒ…æ‹¬èµ„æºåŠ è½½é”™è¯¯ç­‰ã€‚)
  * Uncaught (in promise)(tips:promiseå‘ç”Ÿé”™è¯¯æˆ–reject çŠ¶æ€)

    ```js
    window.addEventListener('unhandledrejection', function (e) {
    var reg_url = /\(([^)]*)\)/;
    var fileMsg = e.reason.stack.split('\n')[1].match(reg_url)[1];
    var fileArr = fileMsg.split(':');
    var lineno = fileArr[fileArr.length - 2];
    var colno = fileArr[fileArr.length - 1];
    var url = fileMsg.slice(0, -lno.length - cno.length - 2);}, true);
    var msg = e.reason.message;
    // ä¸ŠæŠ¥ ã€jsé”™è¯¯ã€‘äº‹ä»¶
    }
    ```

* XMLHttpRequestã€ fetch API æ‹¦æˆªä¸ŠæŠ¥ï¼ˆå¿½ç•¥ï¼‰
* æ—¥å¿—ä¸ŠæŠ¥ ï¼ˆæ„Ÿè§‰ä¼šæœ‰10%-30%ä¸¢åŒ…ç‡ï¼Œä¸è¿‡æœ€åè¿˜æ˜¯è¦çœ‹ç¯å¢ƒğŸ¤£ï¼‰
  * sendBeaconï¼ˆå¼‚æ­¥ï¼‰

    ```js
      window.navigator.sendBeacon('ä¸ŠæŠ¥äº‹ä»¶çš„api', 'æ•°æ®å‚æ•°')
    ```

  * img src

  ```js
  var img = new Image();img.src = API + '?' + 'æ•°æ®å‚æ•°'`
  ```

  * XMLHttpRequest(å¼‚æ­¥ä½†åŒåŸŸè·¨åŸŸé—®é¢˜ï¼Œunloadæƒ…å†µä¸¢åŒ…æ›´å¤š)
* é¡µé¢åœç•™æ—¶é•¿ï¼ˆtipsï¼šiosä¾§æ»‘ä¸ä¸€å®šå…³é—­é¡µé¢ï¼Œç§»åŠ¨ç«¯å¯è®©appåå°å†»ç»“ä¸è§¦å‘é¡µé¢å…³é—­äº‹ä»¶ï¼›pcç«¯é•¿æ—¶é—´æ‰“å¼€é¡µé¢ä¸å…³é—­ï¼‰
  * é•¿è½®è¯¢ï¼ˆæ¨èç§»åŠ¨ç«¯ï¼‰
  * beforeunloadã€unloadï¼ˆæ¨èpcï¼‰


## ğŸˆ Todo

* ç©ºé—²æ—¶æ‰§è¡Œï¼ˆrequestIdleCallbackã€time-slicingï¼‰

  * æ¡ˆä¾‹ä¸€

  ```js
  function ts (gen) {
    if (typeof gen === 'function') gen = gen()
    if (!gen || typeof gen.next !== 'function') return

    return function next () {
      const start = performance.now()
      let res = null
      do {
        res = gen.next()
      } while(!res.done && performance.now() - start < 25);

      if (res.done) return
      setTimeout(next)
    }
  }
  ```

  * æ¡ˆä¾‹äºŒ

  ```js
  // åœ¨é¡¹ç›®çš„å…¥å£æ–‡ä»¶çš„åº•éƒ¨
  const log = async () => {
    const pMonitor = await import('/**.js')
  }
  const oldOnload = window.onload
  window.onload = e => {
    if (oldOnload && typeof oldOnload === 'string') {
      oldOnload(e)
    }
    // å°½é‡ä¸å½±å“é¡µé¢ä¸»çº¿ç¨‹
    // åœ¨æµè§ˆå™¨ç©ºé—²æ—¶æœŸä¾æ¬¡è°ƒç”¨å‡½æ•°
    if (window.requestIdleCallback) {
      window.requestIdleCallback(log)
    } else {
      setTimeout(log)
    }
  }
  ```

  * è°·æ­Œæ¡ˆä¾‹

  ```js
  window.__trackAbandons = () => {
    // Remove the listener so it only runs once.
    document.removeEventListener('visibilitychange', window.__trackAbandons);
    const ANALYTICS_URL = 'https://www.google-analytics.com/collect';
    const GA_COOKIE = document.cookie.replace(
      /(?:(?:^|.*;)\s*_ga\s*\=\s*(?:\w+\.\d\.)([^;]*).*$)|^.*$/, '$1');
    const TRACKING_ID = 'UA-XXXXX-Y';
    const CLIENT_ID =  GA_COOKIE || (Math.random() * Math.pow(2, 52));

    // Send the data to Google Analytics via the Measurement Protocol.
    navigator.sendBeacon && navigator.sendBeacon(ANALYTICS_URL, [
      'v=1', 't=event', 'ec=Load', 'ea=abandon', 'ni=1',
      'dl=' + encodeURIComponent(location.href),
      'dt=' + encodeURIComponent(document.title),
      'tid=' + TRACKING_ID,
      'cid=' + CLIENT_ID,
      'ev=' + Math.round(performance.now()),
    ].join('&'));
  };
  // è¯¥äº‹ä»¶åœ¨é¡µé¢å¸è½½æˆ–è¿›å…¥åå°æ—¶è§¦å‘
  document.addEventListener('visibilitychange', window.__trackAbandons);
  ```

* å¯è§†åŒ–ç›¸å…³

## leadçº¿ä¸Šæƒ…å†µ

* æ”¹é€ 
  * å¼•å…¥æ–¹å¼è¢«æ”¹é€ ã€‚
    åœºæ™¯ï¼š vueç±»çš„å•é¡µé¢åº”ç”¨ï¼Œsdkä¸»æ–‡ä»¶è¢«å¼•å…¥å…¶é¡¹ç›®ã€‚itemIdå’ŒpageIdä¿¡æ¯ä¸¢å¤±ã€‚
    ç ´æ¡ˆï¼š window æ·»åŠ  é¡¹ç›®å’Œé¡µé¢idä¿¡æ¯ï¼Œå¦‚`window._itemId`ã€‚å•é¡µé¢åº”ç”¨ç›‘æµ‹åŠå¼•å…¥æ–¹å¼éœ€æ±‚ã€‚
  * è°ƒç”¨äº‹ä»¶ä»£ç è¢«æ”¹é€ 
    åœºæ™¯ï¼š 100+ä¸ªäº‹ä»¶ä»£ç ï¼ŒåŠé¡¹ç›®å†…æœ‰å¦å¤–ä¸¤ä¸ªç›‘æµ‹ä»£ç ã€‚3ç§ç›‘æµ‹ä»£ç éƒ½æ˜¯ä¸åŒè§¦å‘æ–¹å¼ï¼ŒåŸ‹ç æ–¹å¯¹å…¶è¿›è¡Œæ”¹é€ ã€‚
    ç ´æ¡ˆï¼š è§¦å‘æ–¹å¼ä¸åŒï¼Œæ•°æ®å·®å¼‚ï¼›é‡Œé¢æœ‰eval æœ‰æŠ¥é”™å›å½±å“åˆ«çš„ã€‚
    æé†’ï¼š è§†é¢‘ç›‘å¬äº‹ä»¶è§¦å‘æœºåˆ¶æ˜¯å°½å¯èƒ½çš„å¤šè§¦å‘ï¼Œæ‰€ä»¥ä¼šæœ‰ç©¿é€ä¹Ÿä¼šæœ‰è¿å‡»
* ç›‘æµ‹é¡¹ç›®ç»“æ„ç›¸å…³
  * é¡µé¢åµŒå¥—iframe
    åœºæ™¯ï¼š iframeæœ‰äº‹ä»¶éœ€è¦è§¦å‘ï¼Œå¯èƒ½åªæœ‰ä¸€ä¸ªé¡µé¢ç›‘æµ‹ä»£ç ï¼Œiframeå…±ç”¨pageç›‘æµ‹ä»£ç å›å¢åŠ pv
    ç ´æ¡ˆï¼š æœ‰äº‹ä»¶æ‰è§¦å‘iframeï¼Œ pvå¯ä»¥å‡å»è§¦å‘iframeæ—¶é—´ã€‚æˆ–è€…å¯¹pvé‡é™æƒå½“æˆå¤šä½™çš„åˆ·æ–°é‡
  * åœºæ™¯ï¼š pcç«¯æ˜¯é¡µé¢åµŒå¥—iframeï¼Œç§»åŠ¨ç«¯æ˜¯è·³å»åˆ«çš„é¡µé¢ï¼ˆç±»å¦‚é—®å·ï¼Œå¡«å†™å®Œè¿˜ä¼šè·³å›åŸé¡µé¢ï¼‰
    ç ´æ¡ˆï¼š åŸºäºåœºæ™¯æƒ…å†µ å‡å»pvå€¼ï¼›å¯¹pvé‡é™æƒå½“æˆå¤šä½™çš„åˆ·æ–°é‡
* éƒ¨ç½²
  * åœºæ™¯ï¼š ç”Ÿäº§é…ç½®è¢«æ”¹åŠ¨ï¼Œsdkä»£ç æ²¡æœ‰æ›¿æ¢æˆç”Ÿäº§ç¯å¢ƒ
    ç ´æ¡ˆï¼š åŠæ—¶å‘ç°å¹¶æ±‡æŠ¥ï¼Œåšæ€»ç»“

## :mag: PS

![é¡µé¢](https://static.geekbang.org/infoq/5c6bce24ba464.png)

* ç”Ÿå‘½å‘¨æœŸï¼ˆonload...ï¼‰
  * åœç•™æ—¶é—´

    |è¿›å…¥|æ´»è·ƒçŠ¶æ€åˆ‡æ¢|ç¦»å¼€|
    |:---|:---|:----|
    |onload||onbeforeunload|
    ||document.visibilityState(hidden/visible)ã€document.hidden(true\false)||
    |pageshow||pagehide|
  * é¦–å±æ—¶é—´ ï¼Ÿï¼Ÿï¼Ÿæ²¡å›¾ç‰‡æ—¶ï¼Ÿï¼Ÿï¼Ÿé¡µé¢å¤„äºç¨³å®šçŠ¶æ€å‰æœ€åä¸€æ¬¡ dom å˜åŒ–çš„æ—¶åˆ» - window.performance.timing.navigationStart

```text
é‡å®šå‘æ¬¡æ•°ï¼šperformance.navigation.redirectCount
é‡å®šå‘è€—æ—¶: redirectEnd - redirectStart
DNS è§£æè€—æ—¶: domainLookupEnd - domainLookupStart
TCP è¿æ¥è€—æ—¶: connectEnd - connectStart
SSL å®‰å…¨è¿æ¥è€—æ—¶: connectEnd - secureConnectionStart
ç½‘ç»œè¯·æ±‚è€—æ—¶ (TTFB): responseStart - requestStart
æ•°æ®ä¼ è¾“è€—æ—¶: responseEnd - responseStart
DOM è§£æè€—æ—¶: domInteractive - responseEnd
èµ„æºåŠ è½½è€—æ—¶: loadEventStart - domContentLoadedEventEnd
é¦–åŒ…æ—¶é—´: responseStart - domainLookupStart
ç™½å±æ—¶é—´: responseEnd - fetchStart
é¦–æ¬¡å¯äº¤äº’æ—¶é—´: domInteractive - fetchStart
DOM Ready æ—¶é—´: domContentLoadEventEnd - fetchStart
é¡µé¢å®Œå…¨åŠ è½½æ—¶é—´: loadEventStart - fetchStart
http å¤´éƒ¨å¤§å°ï¼š transferSize - encodedBodySize
```

### performance æ–¹æ³•

performance.getEntries()
performance.getEntriesByName()
performance.getEntriesByType()
performance.mark()
performance.clearMarks()
performance.measure()
performance.clearMeasures()
performance.now()

```js
// æ¡ˆä¾‹

// æŸç±»èµ„æºçš„åŠ è½½æ—¶é—´ï¼Œå¯æµ‹é‡å›¾ç‰‡ã€jsã€cssã€XHR
resourceListEntries.forEach(resource => {
    if (resource.initiatorType == 'img') {
    console.info(`Time taken to load ${resource.name}: `, resource.responseEnd - resource.startTime);
    }
});

// scriptåŠ è½½è€—æ—¶
const p = window.performance.getEntries();
let cssR = p.filter(ele => ele.initiatorType === "script");
Math.max(...cssR.map((ele) => ele.responseEnd)) - Math.min(...cssR.map((ele) => ele.startTime));

```

## æ€§èƒ½ç›‘æµ‹å·¥å…·

* Lighthouse
* PageSpeed
* WebPageTest
* Pingdom
* PhantomJS

## æ€§èƒ½ç›‘æµ‹äº§å“

* [oneapm](https://www.oneapm.com/bi/feature.html)
* [Datadog](https://www.datadoghq.com/rum/)
* [FrontJs](https://www.frontjs.com/)



* ç›¸å…³å‚è€ƒèµ„æ–™
  * [ç™¾åº¦å‰ç«¯ç»Ÿè®¡æ¡†æ¶](https://github.com/fex-team/alogs)
  * [mixpanel å¼€æº](https://github.com/mixpanel/mixpanel-js)
  * [segmentio å¼€æº](https://github.com/segmentio/analytics.js)
* [First Meaningful Paintï¼Œé¦–æ¬¡æœ‰æ•ˆæ¸²æŸ“æ—¶é•¿](https://docs.google.com/document/d/1BR94tJdZLsin5poeet0XoTW60M0SjvOJQttKT-JK8HI/view#heading=h.ycg9fbz776q3)
* [èš‚èšé‡‘æœå¦‚ä½•æŠŠå‰ç«¯æ€§èƒ½ç›‘æ§åšåˆ°æè‡´?](https://www.infoq.cn/article/Dxa8aM44oz*Lukk5Ufhy)
* [ä»¥ç”¨æˆ·ä¸ºä¸­å¿ƒçš„æ€§èƒ½æŒ‡æ ‡](https://developers.google.com/web/fundamentals/performance/user-centric-performance-metrics#_15)
* [è…¾è®¯app ç›¸å…³ua](http://www.alloyteam.com/2015/10/uas-secret/)
* [å¦‚ä½•è¿›è¡Œæ€§èƒ½ç›‘æµ‹](http://www.alloyteam.com/2020/01/14184/#prettyPhoto)
